name: Deploy Protection Check

# åœ¨éƒ¨ç½²å‰è¿›è¡Œé¢å¤–çš„å®‰å…¨æ£€æŸ¥
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  pre-deploy-checks:
    name: Pre-deployment Security Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # è·å–æœ€è¿‘2ä¸ªcommitï¼Œä»¥ä¾¿ä¸HEAD~1å¯¹æ¯”

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Check for secrets
        run: |
          echo "ğŸ” Checking for potential secrets in code..."
          # æ£€æŸ¥æ˜¯å¦æœ‰æ½œåœ¨çš„secretsè¢«æäº¤
          if git diff --name-only HEAD~1 HEAD | grep -E '\.(env|key|pem|p12|pfx)$'; then
            echo "âŒ Environment or key files detected in commit!"
            exit 1
          fi

          # æ£€æŸ¥ä»£ç ä¸­çš„ç¡¬ç¼–ç secrets
          if grep -rE '(password|secret|api_key|apikey|token).*=.*["'"'"'][^"'"'"']{20,}["'"'"']' --exclude-dir=node_modules --exclude-dir=.git . 2>/dev/null; then
            echo "âš ï¸  Potential hardcoded secrets detected!"
            echo "Please review the above matches"
            exit 1
          fi
          echo "âœ… No secrets detected"

      - name: Verify environment variables
        run: |
          echo "ğŸ” Verifying required environment variables are documented..."
          if [ ! -f ".env.example" ]; then
            echo "âŒ .env.example file not found!"
            exit 1
          fi
          echo "âœ… Environment template exists"

      - name: Check for breaking changes
        run: |
          echo "ğŸ” Checking for potential breaking changes..."
          # æ£€æŸ¥prisma schemaæ˜¯å¦æœ‰å˜æ›´
          if git diff --name-only HEAD~1 HEAD | grep "prisma/schema.prisma"; then
            echo "âš ï¸  Database schema changed - ensure migrations are ready!"
          fi

          # æ£€æŸ¥APIè·¯ç”±å˜æ›´
          if git diff HEAD~1 HEAD | grep -E '@(Get|Post|Put|Delete|Patch)\('; then
            echo "âš ï¸  API routes changed - check for breaking changes!"
          fi

      - name: Build verification
        run: |
          echo "ğŸ—ï¸  Verifying build..."
          npm run build
          echo "âœ… Build successful"

      - name: Summary
        run: |
          echo "âœ… All pre-deployment checks passed!"
          echo "ğŸ“¦ Ready for deployment to production"
