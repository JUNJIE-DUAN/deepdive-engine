name: Smoke Tests

# éƒ¨ç½²åè¿è¡Œsmoke testséªŒè¯ç³»ç»Ÿæ˜¯å¦æ­£å¸¸
on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to test"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging
  schedule:
    # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆç”Ÿäº§ç¯å¢ƒå¥åº·ç›‘æ§ï¼‰
    - cron: "0 * * * *"

jobs:
  smoke-test:
    name: Smoke Tests - ${{ github.event.inputs.environment || 'production' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment URL
        id: set-url
        run: |
          if [ "${{ github.event.inputs.environment }}" = "staging" ]; then
            echo "API_URL=https://staging-api.deepdive.app" >> $GITHUB_OUTPUT
            echo "WEB_URL=https://staging.deepdive.app" >> $GITHUB_OUTPUT
          else
            echo "API_URL=https://api.deepdive.app" >> $GITHUB_OUTPUT
            echo "WEB_URL=https://deepdive.app" >> $GITHUB_OUTPUT
          fi

      - name: Health Check - API
        run: |
          echo "ğŸ¥ Checking API health..."
          response=$(curl -s -w "\n%{http_code}" ${{ steps.set-url.outputs.API_URL }}/api/v1/health)
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          echo "Status Code: $http_code"
          echo "Response: $body"

          if [ "$http_code" != "200" ]; then
            echo "âŒ Health check failed!"
            exit 1
          fi
          echo "âœ… API is healthy"

      - name: Health Check - Frontend
        run: |
          echo "ğŸ¥ Checking frontend health..."
          http_code=$(curl -s -o /dev/null -w "%{http_code}" ${{ steps.set-url.outputs.WEB_URL }})

          echo "Status Code: $http_code"

          if [ "$http_code" != "200" ]; then
            echo "âŒ Frontend health check failed!"
            exit 1
          fi
          echo "âœ… Frontend is healthy"

      - name: API Endpoint Tests
        run: |
          echo "ğŸ§ª Testing API endpoints..."

          # Test resources endpoint
          echo "Testing GET /api/v1/resources..."
          http_code=$(curl -s -o /dev/null -w "%{http_code}" ${{ steps.set-url.outputs.API_URL }}/api/v1/resources)
          if [ "$http_code" != "200" ]; then
            echo "âŒ Resources endpoint failed! (HTTP $http_code)"
            exit 1
          fi
          echo "âœ… Resources endpoint OK"

          # Test crawler endpoints
          echo "Testing crawler endpoints..."
          for crawler in arxiv github hackernews; do
            echo "  - Testing /api/v1/proxy/$crawler..."
            http_code=$(curl -s -o /dev/null -w "%{http_code}" ${{ steps.set-url.outputs.API_URL }}/api/v1/proxy/$crawler)
            if [ "$http_code" != "200" ] && [ "$http_code" != "404" ]; then
              echo "âŒ $crawler endpoint failed! (HTTP $http_code)"
              exit 1
            fi
            echo "  âœ… $crawler endpoint OK"
          done

          # Test deduplication endpoint
          echo "Testing POST /api/v1/deduplication/analyze..."
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -d '{"urls":["https://example.com"],"contents":["test"]}' \
            ${{ steps.set-url.outputs.API_URL }}/api/v1/deduplication/analyze)
          http_code=$(echo "$response" | tail -n1)
          if [ "$http_code" != "200" ] && [ "$http_code" != "201" ]; then
            echo "âŒ Deduplication endpoint failed! (HTTP $http_code)"
            exit 1
          fi
          echo "âœ… Deduplication endpoint OK"

          echo "âœ… All API endpoints responding"

      - name: Database Connectivity
        run: |
          echo "ğŸ—„ï¸  Checking database connectivity..."
          # Health endpointåº”è¯¥åŒ…å«databaseçŠ¶æ€
          response=$(curl -s ${{ steps.set-url.outputs.API_URL }}/api/v1/health)
          echo "Response: $response"

          if echo "$response" | grep -q "ok"; then
            echo "âœ… Database connection is healthy"
          else
            echo "âŒ Database connection issue detected!"
            exit 1
          fi

      - name: Performance Check
        run: |
          echo "âš¡ Checking API response time..."
          response_time=$(curl -s -o /dev/null -w "%{time_total}" ${{ steps.set-url.outputs.API_URL }}/api/v1/health)

          echo "Response time: ${response_time}s"

          # å¦‚æœå“åº”æ—¶é—´è¶…è¿‡5ç§’ï¼Œå‘å‡ºè­¦å‘Š
          if (( $(echo "$response_time > 5" | bc -l) )); then
            echo "âš ï¸  Response time is slow (>${response_time}s)"
            exit 1
          fi

          echo "âœ… Response time is acceptable"

      - name: Summary
        if: success()
        run: |
          echo "âœ… All smoke tests passed!"
          echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ Smoke tests failed!"
          echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "Please investigate immediately!"
          # TODO: é›†æˆSlack/Discordé€šçŸ¥
