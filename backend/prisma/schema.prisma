// This is your Prisma schema file
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ ç”¨æˆ·ç›¸å…³ ============

model User {
  id           String  @id @default(uuid())
  email        String  @unique
  username     String? @unique
  passwordHash String? @map("password_hash")

  // OAuth
  oauthProvider String? @map("oauth_provider")
  oauthId       String? @map("oauth_id")

  // è®¢é˜…
  subscriptionTier      String    @default("free") @map("subscription_tier")
  subscriptionExpiresAt DateTime? @map("subscription_expires_at")

  // ä¸ªäººä¿¡æ¯
  fullName  String? @map("full_name")
  avatarUrl String? @map("avatar_url")
  bio       String? @db.Text

  // åå¥½è®¾ç½®
  preferences Json @default("{}")

  // çŠ¶æ€
  isActive   Boolean @default(true) @map("is_active")
  isVerified Boolean @default(false) @map("is_verified")

  // æ—¶é—´æˆ³
  createdAt   DateTime  @default(now()) @map("created_at")
  lastLoginAt DateTime? @map("last_login_at")

  // å…³ç³»
  interests     UserInterest[]
  collections   Collection[]
  activities    UserActivity[]
  learningPaths LearningPath[]
  notes         Note[]
  comments      Comment[]
  reports       Report[]
  youtubeVideos YouTubeVideo[]
  workspaces    Workspace[]

  @@map("users")
}

model UserInterest {
  id       String  @id @default(uuid())
  userId   String  @map("user_id")
  tag      String
  category String?
  weight   Decimal @default(1.0) @db.Decimal(5, 4)
  source   String  @default("manual")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tag])
  @@index([userId])
  @@index([tag])
  @@map("user_interests")
}

// ============ èµ„æºç›¸å…³ ============

enum ResourceType {
  PAPER
  BLOG
  REPORT
  YOUTUBE_VIDEO
  NEWS
  PROJECT
  EVENT
  RSS
  POLICY
}

enum WorkspaceStatus {
  ACTIVE
  ARCHIVED
}

enum TaskStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
}

model Resource {
  id   String       @id @default(uuid())
  type ResourceType

  // åŸºç¡€ä¿¡æ¯
  title        String  @db.VarChar(1000)
  abstract     String? @db.Text
  content      String? @db.Text
  sourceUrl    String  @map("source_url") @db.Text
  pdfUrl       String? @map("pdf_url") @db.Text
  thumbnailUrl String? @map("thumbnail_url") @db.Text
  codeUrl      String? @map("code_url") @db.Text

  // ä½œè€…/æœºæ„
  authors       Json?
  organizations Json?

  // æ—¶é—´
  publishedAt DateTime? @map("published_at")

  // AIç”Ÿæˆå­—æ®µ
  aiSummary       String? @map("ai_summary") @db.Text
  keyInsights     Json?   @map("key_insights")
  difficultyLevel Int?    @map("difficulty_level")
  prerequisites   Json?

  // ç»“æ„åŒ–AIæ‘˜è¦ï¼ˆæ–°å¢ï¼Œä¸ºå‰ç«¯æœ€æ–°ç‰ˆæœ¬ç»„ä»¶æä¾›æ”¯æŒï¼‰
  structuredAISummary Json? @map("structured_ai_summary")

  // åˆ†ç±»
  primaryCategory String? @map("primary_category")
  categories      Json?   @default("[]")
  tags            Json?   @default("[]")
  autoTags        Json?   @default("[]") @map("auto_tags")

  // è´¨é‡è¯„åˆ†
  qualityScore  Decimal? @map("quality_score") @db.Decimal(5, 2)
  trendingScore Decimal? @map("trending_score") @db.Decimal(10, 2)

  // ç»Ÿè®¡
  viewCount    Int @default(0) @map("view_count")
  saveCount    Int @default(0) @map("save_count")
  upvoteCount  Int @default(0) @map("upvote_count")
  commentCount Int @default(0) @map("comment_count")

  // å…ƒæ•°æ®
  metadata Json? @default("{}")

  // MongoDB åŸå§‹æ•°æ®å¼•ç”¨ï¼ˆå…³é”®ï¼ï¼‰
  rawDataId String? @map("raw_data_id")

  // å‘é‡å¼•ç”¨
  embeddingId String? @map("embedding_id")

  // æ•°æ®é‡‡é›†ç›¸å…³ï¼ˆæ–°å¢ï¼‰
  sourceType       String?         @map("source_type") // arxiv, medium, youtubeç­‰
  externalId       String?         @map("external_id") // å¤–éƒ¨ç³»ç»ŸID
  collectionTaskId String?         @map("collection_task_id")
  collectionTask   CollectionTask? @relation(fields: [collectionTaskId], references: [id])

  // æ—¶é—´æˆ³
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // å…³ç³»
  collectionItems    CollectionItem[]
  activities         UserActivity[]
  notes              Note[]
  comments           Comment[]
  workspaceResources WorkspaceResource[]

  @@index([type, publishedAt(sort: Desc)])
  @@index([qualityScore(sort: Desc)])
  @@index([trendingScore(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@index([sourceType, createdAt(sort: Desc)])
  @@index([externalId])
  @@index([collectionTaskId])
  @@map("resources")
}

// ============ æ”¶è—ç›¸å…³ ============

model Collection {
  id          String  @id @default(uuid())
  userId      String  @map("user_id")
  name        String  @db.VarChar(200)
  description String? @db.Text
  isPublic    Boolean @default(false) @map("is_public")
  sortOrder   Int     @default(0) @map("sort_order")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CollectionItem[]

  @@index([userId])
  @@map("collections")
}

model CollectionItem {
  id           String  @id @default(uuid())
  collectionId String  @map("collection_id")
  resourceId   String  @map("resource_id")
  note         String? @db.Text
  position     Int     @default(0)

  addedAt DateTime @default(now()) @map("added_at")

  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  resource   Resource   @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([collectionId, resourceId])
  @@index([collectionId])
  @@index([resourceId])
  @@map("collection_items")
}

// ============ ç”¨æˆ·è¡Œä¸º ============

enum ActivityType {
  VIEW
  CLICK
  SAVE
  UNSAVE
  UPVOTE
  COMMENT
  SHARE
}

model UserActivity {
  id           String       @id @default(uuid())
  userId       String       @map("user_id")
  resourceId   String       @map("resource_id")
  activityType ActivityType @map("activity_type")

  durationSeconds Int?     @map("duration_seconds")
  scrollDepth     Decimal? @map("scroll_depth") @db.Decimal(5, 2)
  metadata        Json?

  deviceType String? @map("device_type")
  userAgent  String? @map("user_agent") @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([resourceId])
  @@index([activityType])
  @@map("user_activities")
}

// ============ å­¦ä¹ è·¯å¾„ ============

enum LearningPathStatus {
  ACTIVE
  PAUSED
  COMPLETED
}

model LearningPath {
  id       String             @id @default(uuid())
  userId   String             @map("user_id")
  title    String             @db.VarChar(200)
  goal     String?            @db.Text
  status   LearningPathStatus @default(ACTIVE)
  progress Decimal            @default(0) @db.Decimal(5, 2)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  steps LearningPathStep[]

  @@index([userId])
  @@map("learning_paths")
}

enum StepStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

model LearningPathStep {
  id        String     @id @default(uuid())
  pathId    String     @map("path_id")
  stepOrder Int        @map("step_order")
  conceptId String     @map("concept_id")
  resources Json?
  status    StepStatus @default(PENDING)

  completedAt DateTime? @map("completed_at")

  path LearningPath @relation(fields: [pathId], references: [id], onDelete: Cascade)

  @@unique([pathId, stepOrder])
  @@index([pathId])
  @@map("learning_path_steps")
}

// ============ ç¬”è®°ç³»ç»Ÿ ============

model Note {
  id         String @id @default(uuid())
  userId     String @map("user_id")
  resourceId String @map("resource_id")

  // ç¬”è®°å†…å®¹
  content String @db.Text

  // é«˜äº®æ ‡æ³¨æ•°æ® (JSON)
  highlights Json? @default("[]")

  // AIè§£é‡Šå’Œæ´å¯Ÿ
  aiInsights Json? @map("ai_insights")

  // å…³è”çš„çŸ¥è¯†å›¾è°±èŠ‚ç‚¹
  graphNodes Json? @default("[]") @map("graph_nodes")

  // æ ‡ç­¾
  tags Json? @default("[]")

  // æ˜¯å¦å…¬å¼€
  isPublic Boolean @default(false) @map("is_public")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([resourceId])
  @@index([createdAt(sort: Desc)])
  @@map("notes")
}

// ============ è¯„è®ºç³»ç»Ÿ ============

model Comment {
  id         String @id @default(uuid())
  userId     String @map("user_id")
  resourceId String @map("resource_id")

  // è¯„è®ºå†…å®¹
  content String @db.Text

  // åµŒå¥—å›å¤æ”¯æŒ
  parentId String? @map("parent_id")

  // ç»Ÿè®¡
  upvoteCount Int @default(0) @map("upvote_count")
  replyCount  Int @default(0) @map("reply_count")

  // çŠ¶æ€
  isEdited  Boolean @default(false) @map("is_edited")
  isDeleted Boolean @default(false) @map("is_deleted")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // å…³ç³»
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  resource Resource  @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[] @relation("CommentReplies")

  @@index([userId])
  @@index([resourceId])
  @@index([parentId])
  @@index([createdAt(sort: Desc)])
  @@map("comments")
}

// ============ æŠ¥å‘Šç³»ç»Ÿ ============

model Report {
  id     String @id @default(uuid())
  userId String @map("user_id")

  // æŠ¥å‘ŠåŸºæœ¬ä¿¡æ¯
  title        String @db.VarChar(500)
  template     String @db.VarChar(50) // comparison, trend, learning-path, literature-review
  templateName String @map("template_name") @db.VarChar(100) // å¯¹æ¯”åˆ†æ, è¶‹åŠ¿æŠ¥å‘Š, etc.
  templateIcon String @map("template_icon") @db.VarChar(10) // ğŸ“Š, ğŸ“ˆ, etc.

  // æŠ¥å‘Šå†…å®¹
  summary  String @db.Text // æ ¸å¿ƒæ‘˜è¦
  sections Json // [{ title: string, content: string }]

  // å…³è”çš„èµ„æº
  resourceIds   Json @map("resource_ids") // [resourceId1, resourceId2, ...]
  resourceCount Int  @map("resource_count")

  // AIç”Ÿæˆå…ƒæ•°æ®
  metadata    Json? // { model, tokensUsed, generationTime, ... }
  workspaceId String? @map("workspace_id")
  taskId      String? @map("task_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // å…³ç³»
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace?     @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  task      WorkspaceTask? @relation(fields: [taskId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([template])
  @@index([workspaceId])
  @@index([taskId])
  @@index([createdAt(sort: Desc)])
  @@map("reports")
}

model ReportTemplate {
  id           String   @id
  name         String
  category     String
  version      Int
  description  String?
  schema       Json
  promptConfig Json
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  tasks WorkspaceTask[]

  @@map("report_templates")
}

model Workspace {
  id        String          @id @default(uuid())
  userId    String          @map("user_id")
  status    WorkspaceStatus @default(ACTIVE)
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt @map("updated_at")

  user      User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  resources WorkspaceResource[]
  tasks     WorkspaceTask[]
  reports   Report[]

  @@index([userId])
  @@map("workspaces")
}

model WorkspaceResource {
  id          String   @id @default(uuid())
  workspaceId String   @map("workspace_id")
  resourceId  String   @map("resource_id")
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  resource  Resource  @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, resourceId])
  @@index([workspaceId])
  @@index([resourceId])
  @@map("workspace_resources")
}

model WorkspaceTask {
  id             String     @id @default(uuid())
  workspaceId    String     @map("workspace_id")
  templateId     String     @map("template_id")
  externalTaskId String?    @unique @map("external_task_id")
  model          String
  status         TaskStatus @default(PENDING)
  queuePosition  Int?       @map("queue_position")
  estimatedTime  Int?       @map("estimated_time")
  startedAt      DateTime?  @map("started_at")
  finishedAt     DateTime?  @map("finished_at")
  parameters     Json?
  result         Json?
  error          Json?
  cost           Json?
  metadata       Json?
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  workspace Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  template  ReportTemplate @relation(fields: [templateId], references: [id], onDelete: Restrict)
  reports   Report[]

  @@index([workspaceId])
  @@index([templateId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("workspace_tasks")
}

// ============ YouTubeè§†é¢‘ç³»ç»Ÿ ============

model YouTubeVideo {
  id     String @id @default(uuid())
  userId String @map("user_id")

  // è§†é¢‘åŸºæœ¬ä¿¡æ¯
  videoId String @map("video_id") @db.VarChar(100) // YouTubeè§†é¢‘ID
  title   String @db.VarChar(1000)
  url     String @db.Text

  // å­—å¹•ä¿¡æ¯
  transcript     Json? // [{ start: number, duration: number, text: string }]
  translatedText String? @map("translated_text") @db.Text

  // AIç”Ÿæˆçš„æŠ¥å‘Š
  aiReport Json? @map("ai_report") // { title, summary, sections }

  // æ—¶é—´æˆ³
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // å…³ç³»
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("youtube_videos")
}

// ============ æŠ¥å‘Šç›¸å…³ (Reports TAB) ============

model ReportPublisher {
  id          String  @id @default(uuid())
  name        String  @unique
  displayName String
  description String? @db.Text
  logoUrl     String? @map("logo_url")
  website     String?
  category    String // "enterprise", "analyst", "research", "security"
  rssFeeds    Json?   @default("[]") @map("rss_feeds") // RSS æº URL åˆ—è¡¨
  isActive    Boolean @default(true)

  collectedReports CollectedReport[]
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")

  @@index([category])
  @@index([name])
  @@map("report_publishers")
}

model CollectedReport {
  id String @id @default(uuid())

  // åŸºç¡€ä¿¡æ¯
  title         String   @db.VarChar(1000)
  abstract      String?  @db.Text
  sourceUrl     String   @map("source_url") @db.Text
  publisherName String   @map("publisher_name") // "NVIDIA", "SemiAnalysis" ç­‰
  publishedAt   DateTime @map("published_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // æŠ¥å‘Šå±æ€§
  reportType  String  @map("report_type") // "research", "market-analysis", "threat-report", "technical-whitepaper", "industry-insight"
  category    String // "AI", "Security", "Semiconductors", "Cloud", "Software"
  subCategory String? @map("sub_category")

  // å†…å®¹
  pdfUrl          String? @map("pdf_url") @db.Text
  htmlUrl         String? @map("html_url") @db.Text
  documentContent String? @map("document_content") @db.Text // åŸæ–‡å†…å®¹ï¼ˆå¯é€‰ï¼‰

  // AI å¯ŒåŒ–æ•°æ®
  aiSummary           String? @map("ai_summary") @db.Text
  structuredAISummary Json?   @map("structured_ai_summary") // ReportAISummary ç»“æ„åŒ–æ•°æ®

  // å…ƒæ•°æ®
  authors     Json? @default("[]") // [{ name, title, company }]
  keyMetrics  Json? @default("{}") @map("key_metrics") // { "revenue": "50B", "marketShare": "35%" }
  keyFindings Json? @default("[]") @map("key_findings") // æ ¸å¿ƒå‘ç°åˆ—è¡¨

  // æ¥æºè¿½è¸ª
  sourceType  String  @map("source_type") // "official-blog", "rss-feed", "pdf-upload", "web-scrape"
  rssSourceId String? @map("rss_source_id") // å…³è”çš„ RSS æº

  // ç»Ÿè®¡æ•°æ®
  viewCount      Int   @default(0) @map("view_count")
  saveCount      Int   @default(0) @map("save_count")
  upvoteCount    Int   @default(0) @map("upvote_count")
  commentCount   Int   @default(0) @map("comment_count")
  relevanceScore Float @default(0.0) @map("relevance_score") // AI ç›¸å…³æ€§è¯„åˆ†

  // å…ƒæ•°æ®
  tags     Json? @default("[]")
  metadata Json? @default("{}")

  createdAt DateTime @default(now()) @map("created_at")

  // å…³ç³»
  publisherId String?
  publisher   ReportPublisher? @relation(fields: [publisherId], references: [id], onDelete: SetNull)

  @@index([publisherName])
  @@index([reportType])
  @@index([category])
  @@index([publishedAt(sort: Desc)])
  @@map("collected_reports")
}

// ============================================================================
// Data Management Module - Source Whitelist, Collection Rules, and Monitoring
// ============================================================================

enum ImportTaskStatus {
  PENDING
  PROCESSING
  SUCCESS
  FAILED
  CANCELLED
}

model SourceWhitelist {
  id           String @id @default(cuid())
  resourceType String // Store as string to avoid PostgreSQL enum type casting issues

  // å…è®¸çš„åŸŸåæˆ–æ­£åˆ™æ¨¡å¼ï¼ˆå­˜å‚¨ä¸ºJSONæ•°ç»„ï¼‰
  allowedDomains Json // Array<string> æ”¯æŒå®Œæ•´åŸŸåæˆ–é€šé…ç¬¦ (e.g., ["arxiv.org", "*.ieee.org"])
  description    String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å­—æ®µç”¨äºè·Ÿè¸ªéªŒè¯ç»Ÿè®¡
  totalValidated  Int       @default(0)
  totalRejected   Int       @default(0)
  lastValidatedAt DateTime?

  @@unique([resourceType])
  @@index([isActive])
  @@map("source_whitelist")
}

model CollectionRule {
  id           String @id @default(cuid())
  resourceType String // Store as string to avoid PostgreSQL enum type casting issues

  // è°ƒåº¦é…ç½®
  cronExpression String @default("0 */6 * * *") // é»˜è®¤æ¯6å°æ—¶
  maxConcurrent  Int    @default(3) // æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°
  timeout        Int    @default(300) // è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰

  // é‡‡é›†è¿‡æ»¤æ¡ä»¶ï¼ˆå­˜å‚¨ä¸ºJSONï¼‰
  filters Json? // åŒ…å« { keywords: string[], excludeKeywords: string[], domains: string[], etc. }

  // å»é‡ç­–ç•¥
  deduplicationStrategy String @default("CONTENT_HASH") // CONTENT_HASH, URL_ONLY, TITLE_ONLY, CUSTOM

  // è´¨é‡è¯„åˆ†é…ç½®
  minimumQualityScore Float @default(0.5) // 0-1 ä¹‹é—´ï¼Œä½äºæ­¤åˆ†æ•°çš„æ•°æ®å°†è¢«è¿‡æ»¤

  // å¯ç”¨çŠ¶æ€å’Œä¼˜å…ˆçº§
  isActive Boolean @default(true)
  priority Int     @default(0) // æ›´é«˜çš„å€¼è¡¨ç¤ºæ›´é«˜çš„ä¼˜å…ˆçº§

  description     String?
  lastExecutedAt  DateTime?
  nextScheduledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  importTasks ImportTask[]

  @@unique([resourceType])
  @@index([isActive])
  @@index([nextScheduledAt])
  @@map("collection_rules")
}

model ImportTask {
  id String @id @default(cuid())

  resourceType String // Store as string to avoid PostgreSQL enum type casting issues
  ruleId       String?
  rule         CollectionRule? @relation(fields: [ruleId], references: [id], onDelete: SetNull)

  // æºä¿¡æ¯
  sourceUrl    String
  sourceDomain String? // æå–çš„åŸŸåï¼Œç”¨äºå¿«é€ŸæŸ¥è¯¢

  // æ–°å¢ï¼šå…³è”åˆ°å®é™…åˆ›å»ºçš„èµ„æº
  resourceId    String? // å…³è”åˆ°å®é™…èµ„æº (Paper.id, Blog.idç­‰)
  resourceModel String? // èµ„æºç±»å‹è¡¨å (papers, blogsç­‰)

  // æ–°å¢ï¼šå…³è”åˆ°ParsedMetadata
  parsedMetadataId String?
  parsedMetadata   ParsedMetadata? @relation(fields: [parsedMetadataId], references: [id], onDelete: SetNull)

  // ä»»åŠ¡çŠ¶æ€
  status       ImportTaskStatus @default(PENDING)
  statusReason String?

  // å¤„ç†ç»Ÿè®¡
  itemsFound     Int @default(0)
  itemsProcessed Int @default(0)
  itemsSaved     Int @default(0)
  itemsRejected  Int @default(0) // è¢«è¿‡æ»¤æˆ–å»é‡çš„é¡¹ç›®

  // é”™è¯¯è·Ÿè¸ª
  errorMessage String?
  errorDetails Json? // è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

  // å»é‡ä¿¡æ¯
  duplicatesFound      Int   @default(0)
  deduplicationDetails Json? // å»é‡çš„è¯¦ç»†ä¿¡æ¯

  // æ—¶é—´æˆ³
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // æ€§èƒ½æŒ‡æ ‡
  executionTimeMs Int? // æ‰§è¡Œæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

  // å…ƒæ•°æ® - å­˜å‚¨ç”¨æˆ·ç¼–è¾‘åçš„å®Œæ•´å…ƒæ•°æ®
  metadata Json?

  @@index([resourceType])
  @@index([status])
  @@index([sourceDomain])
  @@index([resourceId])
  @@index([createdAt(sort: Desc)])
  @@index([completedAt])
  @@map("import_tasks")
}

// ============ å…ƒæ•°æ®æå–ä¸ç¼“å­˜ ============

model ParsedMetadata {
  id String @id @default(cuid())

  // URLä¿¡æ¯
  sourceUrl String @unique // å”¯ä¸€çš„æºURL
  domain    String // æå–çš„åŸŸåï¼Œç”¨äºå¿«é€ŸæŸ¥è¯¢

  // é¡µé¢å…ƒæ•°æ®
  title         String // HTML <title> æˆ– Open Graph title
  description   String?   @db.Text // é¡µé¢æè¿°
  imageUrl      String? // Open Graph image URL
  authors       Json? // ä½œè€…åˆ—è¡¨ (string[])
  publishedDate DateTime? // å‘å¸ƒæ—¥æœŸ

  // é¡µé¢ä¿¡æ¯
  language     String  @default("en") // é¡µé¢è¯­è¨€ä»£ç  (en, zh, jaç­‰)
  contentType  String  @default("html") // html, pdf, videoç­‰
  siteName     String? // ç½‘ç«™åç§°
  canonicalUrl String? // è§„èŒƒURL
  favicon      String? // ç½‘ç«™favicon URL
  wordCount    Int? // æ–‡ç« å­—æ•°ï¼ˆä»…é€‚ç”¨äºæ–‡æœ¬å†…å®¹ï¼‰

  // å†…å®¹è¯†åˆ«
  contentHash String? // SHA256 hash for duplicate detection

  // è§£æå…ƒæ•°æ®
  parseError   String? // è§£æé”™è¯¯æ¶ˆæ¯
  parseSuccess Boolean @default(true)

  // ç¼“å­˜ç®¡ç†
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expiresAt DateTime? @default(dbgenerated("(now() + interval '7 days')")) // 7å¤©è¿‡æœŸ

  // å…³ç³»
  importTasks ImportTask[]

  @@index([domain])
  @@index([sourceUrl])
  @@index([expiresAt])
  @@map("parsed_metadata")
}

model DataQualityMetric {
  id String @id @default(cuid())

  // å…³è”çš„èµ„æº
  resourceType String // Store as string to avoid PostgreSQL enum type casting issues
  resourceId   String // å®é™…èµ„æºID (paper.id, project.id, news.id, etc.)
  sourceUrl    String? // åŸå§‹æ¥æºURL

  // è´¨é‡è¯„åˆ†ï¼ˆ0-100ï¼‰
  qualityScore      Float @default(0)
  completenessScore Float @default(0) // å®Œæ•´æ€§è¯„åˆ†
  relevanceScore    Float @default(0) // ç›¸å…³æ€§è¯„åˆ†

  // å»é‡ä¿¡æ¯
  duplicateScore       Float   @default(0) // ç›¸ä¼¼åº¦ (0 = å®Œå…¨ä¸åŒ, 100 = é‡å¤)
  potentialDuplicateOf String? // æŒ‡å‘å¯èƒ½çš„é‡å¤é¡¹
  isDuplicate          Boolean @default(false)

  // é—®é¢˜æ ‡è®°
  issues Json? // Array of { type: string, severity: 'LOW'|'MEDIUM'|'HIGH', message: string }

  // æ ‡ç­¾å’Œåˆ†ç±»
  tags     String[]
  category String?

  // å®¡æ ¸çŠ¶æ€
  reviewStatus String    @default("PENDING") // PENDING, APPROVED, REJECTED, NEEDS_REVIEW
  reviewedBy   String?
  reviewNote   String?
  reviewedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([resourceType, resourceId])
  @@index([resourceType])
  @@index([isDuplicate])
  @@index([qualityScore])
  @@index([reviewStatus])
  @@map("data_quality_metrics")
}

model CollectionStatistics {
  id String @id @default(cuid())

  resourceType String // Store as string to avoid PostgreSQL enum type casting issues

  // ç»Ÿè®¡æ•°æ®
  totalItems      Int @default(0)
  totalCollected  Int @default(0)
  totalSuccessful Int @default(0)
  totalFailed     Int @default(0)
  totalDuplicates Int @default(0)
  totalRejected   Int @default(0)

  // è´¨é‡ç»Ÿè®¡
  averageQualityScore        Float @default(0)
  itemsAboveQualityThreshold Int   @default(0)
  itemsBelowQualityThreshold Int   @default(0)

  // æ—¶é—´ç»Ÿè®¡
  lastCollectionAt            DateTime?
  nextScheduledAt             DateTime?
  averageCollectionDurationMs Int? // å¹³å‡é‡‡é›†è€—æ—¶

  // æˆåŠŸç‡
  successRate Float @default(0)

  // æ—¶é—´æ®µç»Ÿè®¡
  period String? // DAY, WEEK, MONTH (ç”¨äºæ—¶é—´åºåˆ—åˆ†æ)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([resourceType])
  @@index([period])
  @@map("collection_statistics")
}

// ============================================================================
// Collection Configuration - ä¸“ä¸šé‡‡é›†å™¨é…ç½®
// ============================================================================

model CollectionConfiguration {
  id String @id @default(cuid())

  resourceType String  @db.VarChar(255) // Store as string to avoid PostgreSQL enum type casting issues
  name         String  @db.VarChar(255)
  description  String? @db.Text

  // å…³é”®è¯å’Œè¿‡æ»¤
  keywords        Json? // Array<string> - åŒ…å«å…³é”®è¯
  excludeKeywords Json? // Array<string> - æ’é™¤å…³é”®è¯
  urlPatterns     Json? // Array<string> - URLåŒ¹é…æ¨¡å¼ï¼Œæ”¯æŒ*é€šé…ç¬¦

  // é‡‡é›†è°ƒåº¦
  cronExpression String @default("0 */6 * * *") // Cronè¡¨è¾¾å¼
  maxConcurrent  Int    @default(3) // æœ€å¤§å¹¶å‘
  timeout        Int    @default(300) // è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰

  // çŠ¶æ€
  isActive Boolean @default(true)

  // ç»Ÿè®¡
  totalCollected  Int       @default(0)
  lastCollectedAt DateTime?

  // æ—¶é—´æˆ³
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([resourceType, name])
  @@index([resourceType])
  @@index([isActive])
  @@map("collection_configurations")
}

// ============================================================================
// Enhanced Data Collection System - å¢å¼ºçš„æ•°æ®é‡‡é›†ç³»ç»Ÿ
// ============================================================================

// æ•°æ®æºé…ç½®è¡¨
enum DataSourceType {
  ARXIV
  PUBMED
  IEEE
  ACL_ANTHOLOGY
  MEDIUM
  DEVTO
  SUBSTACK
  HASHNODE
  YOUTUBE
  BILIBILI
  HACKERNEWS
  TECHCRUNCH
  THE_VERGE
  GITHUB
  PRODUCTHUNT
  POLICY_US
  POLICY_EU
  POLICY_CN
  GARTNER
  MCKINSEY
  IDC
  CUSTOM
  RSS
}

enum DataSourceStatus {
  ACTIVE
  PAUSED
  FAILED
  MAINTENANCE
  DEPRECATED
}

model DataSource {
  id          String         @id @default(uuid())
  name        String         @unique
  description String?
  type        DataSourceType
  category    ResourceType // å¯¹åº”çš„èµ„æºç±»å‹

  // è¿æ¥é…ç½®
  baseUrl     String  @map("base_url")
  apiEndpoint String? @map("api_endpoint")
  authType    String? @map("auth_type") // NONE|API_KEY|OAUTH|COOKIE
  credentials String? @db.Text // åŠ å¯†å­˜å‚¨

  // é‡‡é›†é…ç½®
  crawlerType   String @map("crawler_type") // API|SCRAPER|RSS
  crawlerConfig Json   @map("crawler_config") // {selectors, patterns}
  rateLimit     Int?   @map("rate_limit") // æ¯ç§’è¯·æ±‚æ•°

  // å†…å®¹è¿‡æ»¤
  keywords        String[] // ["AI", "Machine Learning"]
  categories      String[] // ["cs.AI", "cs.LG"]
  languages       Json? // ["en", "zh"]
  minQualityScore Float @default(0) @map("min_quality_score")

  // å»é‡é…ç½®
  deduplicationConfig Json? @map("deduplication_config") // {methods, thresholds}

  // çŠ¶æ€ç®¡ç†
  status           DataSourceStatus @default(ACTIVE)
  isVerified       Boolean          @default(false) @map("is_verified")
  lastTestedAt     DateTime?        @map("last_tested_at")
  lastSuccessAt    DateTime?        @map("last_success_at")
  lastErrorMessage String?          @map("last_error")

  // ç»Ÿè®¡ä¿¡æ¯
  totalCollected  Int   @default(0) @map("total_collected")
  totalSuccess    Int   @default(0) @map("total_success")
  totalFailed     Int   @default(0) @map("total_failed")
  totalDuplicates Int   @default(0) @map("total_duplicates")
  successRate     Float @default(0) @map("success_rate")
  averageQuality  Float @default(0) @map("average_quality")

  // å®¡è®¡å­—æ®µ
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")

  // å…³ç³»
  tasks CollectionTask[]

  @@index([type, status])
  @@index([category, status])
  @@map("data_sources")
}

// é‡‡é›†ä»»åŠ¡è¡¨ï¼ˆå¢å¼ºç‰ˆï¼‰
enum CollectionTaskType {
  SCHEDULED
  MANUAL
  IMPORT
  RETRY
}

enum CollectionTaskStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
  PAUSED
}

model CollectionTask {
  id          String             @id @default(uuid())
  name        String
  description String?
  type        CollectionTaskType

  // æ•°æ®æºé…ç½®
  sourceId     String     @map("source_id")
  source       DataSource @relation(fields: [sourceId], references: [id])
  sourceConfig Json       @map("source_config") // {maxResults, category, dateRange}

  // æ‰§è¡Œé…ç½®
  schedule       String? // Cronè¡¨è¾¾å¼
  priority       Int     @default(5) // 1-10
  maxConcurrency Int     @default(5) @map("max_concurrency")
  timeout        Int     @default(300) // ç§’
  retryCount     Int     @default(3) @map("retry_count")

  // å»é‡é…ç½®
  deduplicationRules Json @map("deduplication_rules") // {methods, thresholds}

  // æ‰§è¡ŒçŠ¶æ€
  status      CollectionTaskStatus @default(PENDING)
  progress    Float                @default(0) // 0-100
  currentStep String?              @map("current_step")

  // ç»Ÿè®¡ä¿¡æ¯
  totalItems     Int @default(0) @map("total_items")
  processedItems Int @default(0) @map("processed_items")
  successItems   Int @default(0) @map("success_items")
  failedItems    Int @default(0) @map("failed_items")
  duplicateItems Int @default(0) @map("duplicate_items")
  skippedItems   Int @default(0) @map("skipped_items")

  // æ—¶é—´ä¿¡æ¯
  scheduledAt DateTime? @map("scheduled_at")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  nextRunAt   DateTime? @map("next_run_at")

  // é”™è¯¯ä¿¡æ¯
  errorMessage String? @db.Text @map("error_message")
  errorStack   String? @db.Text @map("error_stack")
  warnings     Json? // ["warning1", "warning2"]

  // ç»“æœæ•°æ®
  resultSummary Json? @map("result_summary") // {avg_quality, sources, etc}
  logs          Json? // æ—¥å¿—æ‘˜è¦

  // å®¡è®¡å­—æ®µ
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")

  // å…³ç³»
  resources            Resource[]
  deduplicationRecords DeduplicationRecord[]

  @@index([status, scheduledAt])
  @@index([sourceId, status])
  @@index([type, createdAt])
  @@map("collection_tasks")
}

// å»é‡è®°å½•è¡¨
enum DuplicateDecision {
  AUTO_SKIP // è‡ªåŠ¨è·³è¿‡ï¼ˆé«˜ç›¸ä¼¼åº¦ï¼‰
  MANUAL_SKIP // äººå·¥ç¡®è®¤è·³è¿‡
  MERGED // åˆå¹¶èµ„æº
  FALSE_POSITIVE // è¯¯åˆ¤ï¼Œå®é™…ä¸é‡å¤
  PENDING_REVIEW // å¾…äººå·¥å®¡æ ¸
}

model DeduplicationRecord {
  id String @id @default(uuid())

  // å…³è”ä¿¡æ¯
  taskId        String?         @map("task_id")
  task          CollectionTask? @relation(fields: [taskId], references: [id])
  resourceId    String?         @map("resource_id") // å¦‚æœä¿ç•™ï¼ŒæŒ‡å‘ä¿ç•™çš„èµ„æº
  duplicateOfId String?         @map("duplicate_of_id") // æŒ‡å‘åŸå§‹èµ„æº

  // æ£€æµ‹æ–¹å¼
  method     String // URL_HASH|TITLE_SIMILARITY|CONTENT_FINGERPRINT|AUTHOR_TIME
  similarity Float // ç›¸ä¼¼åº¦ 0-1
  confidence Float  @default(1.0) // ç½®ä¿¡åº¦

  // å»é‡ä¾æ®
  urlHash            String? @map("url_hash")
  titleHash          String? @map("title_hash")
  contentFingerprint String? @map("content_fingerprint")
  authorTimeKey      String? @map("author_time_key")

  // åŸå§‹æ•°æ®
  originalData Json  @map("original_data") // è¢«å»é‡çš„åŸå§‹æ•°æ®ï¼ˆæ ‡é¢˜ã€URLç­‰ï¼‰
  comparedWith Json? @map("compared_with") // æ¯”è¾ƒçš„èµ„æºä¿¡æ¯

  // å†³ç­–ä¿¡æ¯
  decision  DuplicateDecision
  isCorrect Boolean?          @map("is_correct") // äººå·¥éªŒè¯ç»“æœ

  // å¤„ç†ä¿¡æ¯
  processedBy String?  @map("processed_by") // USER_ID or SYSTEM
  processedAt DateTime @default(now()) @map("processed_at")
  notes       String?

  // å®¡è®¡
  createdAt DateTime @default(now()) @map("created_at")

  @@index([urlHash])
  @@index([titleHash])
  @@index([contentFingerprint])
  @@index([resourceId])
  @@index([decision])
  @@index([taskId])
  @@map("deduplication_records")
}
