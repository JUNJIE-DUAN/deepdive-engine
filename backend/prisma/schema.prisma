// This is your Prisma schema file
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ ç”¨æˆ·ç›¸å…³ ============

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  username        String?   @unique
  passwordHash    String?   @map("password_hash")

  // OAuth
  oauthProvider   String?   @map("oauth_provider")
  oauthId         String?   @map("oauth_id")

  // è®¢é˜…
  subscriptionTier String   @default("free") @map("subscription_tier")
  subscriptionExpiresAt DateTime? @map("subscription_expires_at")

  // ä¸ªäººä¿¡æ¯
  fullName        String?   @map("full_name")
  avatarUrl       String?   @map("avatar_url")
  bio             String?   @db.Text

  // åå¥½è®¾ç½®
  preferences     Json      @default("{}")

  // çŠ¶æ€
  isActive        Boolean   @default(true) @map("is_active")
  isVerified      Boolean   @default(false) @map("is_verified")

  // æ—¶é—´æˆ³
  createdAt       DateTime  @default(now()) @map("created_at")
  lastLoginAt     DateTime? @map("last_login_at")

  // å…³ç³»
  interests       UserInterest[]
  collections     Collection[]
  activities      UserActivity[]
  learningPaths   LearningPath[]
  notes           Note[]
  comments        Comment[]
  reports         Report[]
  youtubeVideos   YouTubeVideo[]
  workspaces      Workspace[]

  @@map("users")
}

model UserInterest {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  tag       String
  category  String?
  weight    Decimal  @default(1.0) @db.Decimal(5, 4)
  source    String   @default("manual")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tag])
  @@index([userId])
  @@index([tag])
  @@map("user_interests")
}

// ============ èµ„æºç›¸å…³ ============

enum ResourceType {
  PAPER
  PROJECT
  NEWS
  EVENT
  RSS
  YOUTUBE_VIDEO
}

enum WorkspaceStatus {
  ACTIVE
  ARCHIVED
}

enum TaskStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
}

model Resource {
  id              String       @id @default(uuid())
  type            ResourceType

  // åŸºç¡€ä¿¡æ¯
  title           String       @db.VarChar(1000)
  abstract        String?      @db.Text
  content         String?      @db.Text
  sourceUrl       String       @map("source_url") @db.Text
  pdfUrl          String?      @map("pdf_url") @db.Text
  thumbnailUrl    String?      @map("thumbnail_url") @db.Text
  codeUrl         String?      @map("code_url") @db.Text

  // ä½œè€…/æœºæ„
  authors         Json?
  organizations   Json?

  // æ—¶é—´
  publishedAt     DateTime?    @map("published_at")

  // AIç”Ÿæˆå­—æ®µ
  aiSummary       String?      @map("ai_summary") @db.Text
  keyInsights     Json?        @map("key_insights")
  difficultyLevel Int?         @map("difficulty_level")
  prerequisites   Json?

  // ç»“æ„åŒ–AIæ‘˜è¦ï¼ˆæ–°å¢ï¼Œä¸ºå‰ç«¯æœ€æ–°ç‰ˆæœ¬ç»„ä»¶æä¾›æ”¯æŒï¼‰
  structuredAISummary Json?    @map("structured_ai_summary")

  // åˆ†ç±»
  primaryCategory String?      @map("primary_category")
  categories      Json?        @default("[]")
  tags            Json?        @default("[]")
  autoTags        Json?        @map("auto_tags") @default("[]")

  // è´¨é‡è¯„åˆ†
  qualityScore    Decimal?     @map("quality_score") @db.Decimal(5, 2)
  trendingScore   Decimal?     @map("trending_score") @db.Decimal(10, 2)

  // ç»Ÿè®¡
  viewCount       Int          @default(0) @map("view_count")
  saveCount       Int          @default(0) @map("save_count")
  upvoteCount     Int          @default(0) @map("upvote_count")
  commentCount    Int          @default(0) @map("comment_count")

  // å…ƒæ•°æ®
  metadata        Json?        @default("{}")

  // MongoDB åŸå§‹æ•°æ®å¼•ç”¨ï¼ˆå…³é”®ï¼ï¼‰
  rawDataId       String?      @map("raw_data_id")

  // å‘é‡å¼•ç”¨
  embeddingId     String?      @map("embedding_id")

  // æ—¶é—´æˆ³
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  // å…³ç³»
  collectionItems CollectionItem[]
  activities      UserActivity[]
  notes           Note[]
  comments        Comment[]
  workspaceResources WorkspaceResource[]

  @@index([type, publishedAt(sort: Desc)])
  @@index([qualityScore(sort: Desc)])
  @@index([trendingScore(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@map("resources")
}

// ============ æ”¶è—ç›¸å…³ ============

model Collection {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  name        String   @db.VarChar(200)
  description String?  @db.Text
  isPublic    Boolean  @default(false) @map("is_public")
  sortOrder   Int      @default(0) @map("sort_order")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CollectionItem[]

  @@index([userId])
  @@map("collections")
}

model CollectionItem {
  id           String    @id @default(uuid())
  collectionId String    @map("collection_id")
  resourceId   String    @map("resource_id")
  note         String?   @db.Text
  position     Int       @default(0)

  addedAt      DateTime  @default(now()) @map("added_at")

  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  resource   Resource   @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([collectionId, resourceId])
  @@index([collectionId])
  @@index([resourceId])
  @@map("collection_items")
}

// ============ ç”¨æˆ·è¡Œä¸º ============

enum ActivityType {
  VIEW
  CLICK
  SAVE
  UNSAVE
  UPVOTE
  COMMENT
  SHARE
}

model UserActivity {
  id              String       @id @default(uuid())
  userId          String       @map("user_id")
  resourceId      String       @map("resource_id")
  activityType    ActivityType @map("activity_type")

  durationSeconds Int?         @map("duration_seconds")
  scrollDepth     Decimal?     @map("scroll_depth") @db.Decimal(5, 2)
  metadata        Json?

  deviceType      String?      @map("device_type")
  userAgent       String?      @map("user_agent") @db.Text

  createdAt       DateTime     @default(now()) @map("created_at")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([resourceId])
  @@index([activityType])
  @@map("user_activities")
}

// ============ å­¦ä¹ è·¯å¾„ ============

enum LearningPathStatus {
  ACTIVE
  PAUSED
  COMPLETED
}

model LearningPath {
  id        String              @id @default(uuid())
  userId    String              @map("user_id")
  title     String              @db.VarChar(200)
  goal      String?             @db.Text
  status    LearningPathStatus  @default(ACTIVE)
  progress  Decimal             @default(0) @db.Decimal(5, 2)

  createdAt DateTime            @default(now()) @map("created_at")
  updatedAt DateTime            @updatedAt @map("updated_at")

  user  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  steps LearningPathStep[]

  @@index([userId])
  @@map("learning_paths")
}

enum StepStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

model LearningPathStep {
  id          String     @id @default(uuid())
  pathId      String     @map("path_id")
  stepOrder   Int        @map("step_order")
  conceptId   String     @map("concept_id")
  resources   Json?
  status      StepStatus @default(PENDING)

  completedAt DateTime?  @map("completed_at")

  path LearningPath @relation(fields: [pathId], references: [id], onDelete: Cascade)

  @@unique([pathId, stepOrder])
  @@index([pathId])
  @@map("learning_path_steps")
}

// ============ ç¬”è®°ç³»ç»Ÿ ============

model Note {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  resourceId  String   @map("resource_id")

  // ç¬”è®°å†…å®¹
  content     String   @db.Text

  // é«˜äº®æ ‡æ³¨æ•°æ® (JSON)
  highlights  Json?    @default("[]")

  // AIè§£é‡Šå’Œæ´å¯Ÿ
  aiInsights  Json?    @map("ai_insights")

  // å…³è”çš„çŸ¥è¯†å›¾è°±èŠ‚ç‚¹
  graphNodes  Json?    @map("graph_nodes") @default("[]")

  // æ ‡ç­¾
  tags        Json?    @default("[]")

  // æ˜¯å¦å…¬å¼€
  isPublic    Boolean  @default(false) @map("is_public")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([resourceId])
  @@index([createdAt(sort: Desc)])
  @@map("notes")
}

// ============ è¯„è®ºç³»ç»Ÿ ============

model Comment {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  resourceId  String    @map("resource_id")

  // è¯„è®ºå†…å®¹
  content     String    @db.Text

  // åµŒå¥—å›å¤æ”¯æŒ
  parentId    String?   @map("parent_id")

  // ç»Ÿè®¡
  upvoteCount Int       @default(0) @map("upvote_count")
  replyCount  Int       @default(0) @map("reply_count")

  // çŠ¶æ€
  isEdited    Boolean   @default(false) @map("is_edited")
  isDeleted   Boolean   @default(false) @map("is_deleted")

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // å…³ç³»
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  resource    Resource  @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  parent      Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     Comment[] @relation("CommentReplies")

  @@index([userId])
  @@index([resourceId])
  @@index([parentId])
  @@index([createdAt(sort: Desc)])
  @@map("comments")
}

// ============ æŠ¥å‘Šç³»ç»Ÿ ============

model Report {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")

  // æŠ¥å‘ŠåŸºæœ¬ä¿¡æ¯
  title         String   @db.VarChar(500)
  template      String   @db.VarChar(50) // comparison, trend, learning-path, literature-review
  templateName  String   @map("template_name") @db.VarChar(100) // å¯¹æ¯”åˆ†æ, è¶‹åŠ¿æŠ¥å‘Š, etc.
  templateIcon  String   @map("template_icon") @db.VarChar(10) // ğŸ“Š, ğŸ“ˆ, etc.

  // æŠ¥å‘Šå†…å®¹
  summary       String   @db.Text // æ ¸å¿ƒæ‘˜è¦
  sections      Json     // [{ title: string, content: string }]

  // å…³è”çš„èµ„æº
  resourceIds   Json     @map("resource_ids") // [resourceId1, resourceId2, ...]
  resourceCount Int      @map("resource_count")

  // AIç”Ÿæˆå…ƒæ•°æ®
  metadata      Json?    // { model, tokensUsed, generationTime, ... }
  workspaceId   String?  @map("workspace_id")
  taskId        String?  @map("task_id")

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // å…³ç³»
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace     Workspace?     @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  task          WorkspaceTask? @relation(fields: [taskId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([template])
  @@index([workspaceId])
  @@index([taskId])
  @@index([createdAt(sort: Desc)])
  @@map("reports")
}

model ReportTemplate {
  id           String   @id
  name         String
  category     String
  version      Int
  description  String?
  schema       Json
  promptConfig Json
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  tasks        WorkspaceTask[]

  @@map("report_templates")
}

model Workspace {
  id        String          @id @default(uuid())
  userId    String          @map("user_id")
  status    WorkspaceStatus @default(ACTIVE)
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt @map("updated_at")

  user       User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  resources  WorkspaceResource[]
  tasks      WorkspaceTask[]
  reports    Report[]

  @@index([userId])
  @@map("workspaces")
}

model WorkspaceResource {
  id          String   @id @default(uuid())
  workspaceId String   @map("workspace_id")
  resourceId  String   @map("resource_id")
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  resource  Resource  @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, resourceId])
  @@index([workspaceId])
  @@index([resourceId])
  @@map("workspace_resources")
}

model WorkspaceTask {
  id            String     @id @default(uuid())
  workspaceId   String     @map("workspace_id")
  templateId    String     @map("template_id")
  externalTaskId String?   @unique @map("external_task_id")
  model         String
  status        TaskStatus @default(PENDING)
  queuePosition Int?       @map("queue_position")
  estimatedTime Int?       @map("estimated_time")
  startedAt     DateTime?  @map("started_at")
  finishedAt    DateTime?  @map("finished_at")
  parameters    Json?
  result        Json?
  error         Json?
  cost          Json?
  metadata      Json?
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  workspace Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  template  ReportTemplate @relation(fields: [templateId], references: [id], onDelete: Restrict)
  reports   Report[]

  @@index([workspaceId])
  @@index([templateId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("workspace_tasks")
}

// ============ YouTubeè§†é¢‘ç³»ç»Ÿ ============

model YouTubeVideo {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")

  // è§†é¢‘åŸºæœ¬ä¿¡æ¯
  videoId         String    @map("video_id") @db.VarChar(100) // YouTubeè§†é¢‘ID
  title           String    @db.VarChar(1000)
  url             String    @db.Text

  // å­—å¹•ä¿¡æ¯
  transcript      Json?     // [{ start: number, duration: number, text: string }]
  translatedText  String?   @map("translated_text") @db.Text

  // AIç”Ÿæˆçš„æŠ¥å‘Š
  aiReport        Json?     @map("ai_report") // { title, summary, sections }

  // æ—¶é—´æˆ³
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // å…³ç³»
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("youtube_videos")
}
