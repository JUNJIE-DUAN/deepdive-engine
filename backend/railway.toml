[build]
builder = "nixpacks"

[build.nixpacksPlan.phases.setup]
nixPkgs = ["nodejs_20", "python3", "gcc", "gnumake"]
aptPkgs = [
  "bzip2",
  "libcairo2-dev",
  "libjpeg-dev",
  "libpango1.0-dev",
  "libgif-dev",
  "openssl",
  "libssl-dev",
  "build-essential",
  "pkg-config"
]

[build.nixpacksPlan]
phases.install.cmds = ["npm ci --legacy-peer-deps"]
phases.build.cmds = ["npx prisma generate", "npm run build"]

[deploy]
startCommand = "sh -c 'set -e; echo \"ğŸš€ Starting deployment...\"; echo \"ğŸ” Running diagnostics...\"; npm run diagnose || echo \"âš ï¸  Diagnostics failed, continuing...\"; echo \"ğŸ“¦ Running migrations...\"; npm run deploy || exit 1; echo \"âœ… Deploy OK, starting server...\"; exec npm run start:prod'"
healthcheckPath = "/api/v1/health"
healthcheckTimeout = 300
restartPolicyType = "on_failure"
restartPolicyMaxRetries = 5
