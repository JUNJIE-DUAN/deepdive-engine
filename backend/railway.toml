[build]
builder = "nixpacks"

[build.nixpacksPlan.phases.setup]
nixPkgs = ["bzip2"]

[build.nixpacksPlan]
phases.install.cmds = ["npm ci --legacy-peer-deps"]
phases.build.cmds = ["npm run build", "npx prisma generate"]

[deploy]
startCommand = "sh -c 'set -e; echo \"ğŸš€ Starting deployment...\"; echo \"ğŸ” Running diagnostics...\"; npm run diagnose || echo \"âš ï¸  Diagnostics failed, continuing...\"; echo \"ğŸ“¦ Running migrations...\"; npm run deploy || exit 1; echo \"âœ… Deploy OK, starting server...\"; exec npm run start:prod'"
healthcheckPath = "/api/v1/health"
healthcheckTimeout = 300
restartPolicyType = "on_failure"
restartPolicyMaxRetries = 5
