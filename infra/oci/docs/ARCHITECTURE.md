# DeepDive Engine - OCI 部署架构详解

## 🏗️ 系统架构总览

```
┌─────────────────────────────────────────────────────────────────────┐
│                      互联网 / 用户端                                 │
└────────────────────────────────┬────────────────────────────────────┘
                                 │
                    ┌────────────▼────────────┐
                    │  OCI 负载均衡器(可选)   │
                    │  Network Load Balancer  │
                    └────────────┬────────────┘
                                 │
        ┌────────────────────────┼────────────────────────┐
        │                        │                        │
        │                        │                        │
   ┌────▼────┐            ┌──────▼──────┐          ┌─────▼─────┐
   │ 前端     │            │ 后端        │          │ AI 服务   │
   │ 实例 1   │            │ 实例 2      │          │ 实例 3    │
   ├──────────┤            ├─────────────┤          ├───────────┤
   │          │            │             │          │           │
   │2vCPU     │            │ 2vCPU       │          │ 2vCPU     │
   │8GB RAM   │            │ 8GB RAM     │          │ 6GB RAM   │
   │          │            │             │          │           │
   │ Next.js  │            │ NestJS API  │          │ FastAPI   │
   │ Nginx    │            │ Node.js     │          │ Python    │
   │          │            │             │          │           │
   │Port 80   │            │ Port 3001   │          │ Port 5000 │
   │Port 443  │            │ REST API    │          │ Websocket │
   └───┬──────┘            └──────┬──────┘          └─────┬─────┘
       │                          │                       │
       │                    ┌─────▼──────────┐            │
       │                    │ 数据库集群     │            │
       │         ┌──────────┼────────────────┼──────────┐ │
       │         │          │ (Backend只)    │          │ │
       │         │          └────────────────┘          │ │
       │         │                                       │ │
       │    ┌────▼────┐  ┌────────────┐  ┌────────┐   │ │
       │    │PostgreSQL   │   MongoDB  │  │  Neo4j │   │ │
       │    │ 关键数据  │  │  原始数据 │  │ 知识   │   │ │
       │    └─────────┘  └────────────┘  │ 图谱   │   │ │
       │                                   └────────┘   │ │
       │    ┌────────────┐  ┌──────────────────────┐  │ │
       │    │   Redis    │  │    Qdrant向量DB     │  │ │
       │    │   缓存     │  │    (AI Service)      │  │ │
       │    └────────────┘  └──────────────────────┘  │ │
       └────────────────────────────────────────────────┘
                          │
        ┌─────────────────▼──────────────────┐
        │    OCI 虚拟云网络 (VCN)             │
        │    CIDR: 10.0.0.0/16              │
        │                                    │
        │  ┌──────────────────────────────┐ │
        │  │ 公共子网 (10.0.1.0/24)       │ │
        │  │ - 前端实例                   │ │
        │  │ - 互联网网关                 │ │
        │  │ - 公共路由表                 │ │
        │  │ - 安全组规则 (HTTP/HTTPS)   │ │
        │  └──────────────────────────────┘ │
        │                                    │
        │  ┌──────────────────────────────┐ │
        │  │ 私有子网 (10.0.2.0/24)       │ │
        │  │ - 后端实例                   │ │
        │  │ - AI 服务实例                │ │
        │  │ - 数据库容器                 │ │
        │  │ - 私有路由表                 │ │
        │  │ - 安全组规则 (内部只)       │ │
        │  └──────────────────────────────┘ │
        │                                    │
        │  ┌──────────────────────────────┐ │
        │  │ 其他网络资源                  │ │
        │  │ - 互联网网关 (IGW)           │ │
        │  │ - 路由表 (RT)                │ │
        │  │ - 安全列表 (SL)              │ │
        │  └──────────────────────────────┘ │
        └────────────────────────────────────┘
                          │
        ┌─────────────────▼──────────────────┐
        │  OCI 其他服务                       │
        │                                    │
        │  ┌──────────────────────────────┐ │
        │  │ Object Storage               │ │
        │  │ - 应用日志                   │ │
        │  │ - 数据库备份                 │ │
        │  │ - 用户上传文件               │ │
        │  │ - Lifecycle 策略自动清理     │ │
        │  └──────────────────────────────┘ │
        │                                    │
        │  ┌──────────────────────────────┐ │
        │  │ Container Registry (OCIR)    │ │
        │  │ - Docker 镜像存储            │ │
        │  │ - Frontend 镜像              │ │
        │  │ - Backend 镜像               │ │
        │  │ - AI Service 镜像            │ │
        │  └──────────────────────────────┘ │
        │                                    │
        │  ┌──────────────────────────────┐ │
        │  │ Monitoring & Logging         │ │
        │  │ - OCI Monitoring             │ │
        │  │ - 成本告警                   │ │
        │  │ - 日志收集                   │ │
        │  │ - Slack 集成                 │ │
        │  └──────────────────────────────┘ │
        │                                    │
        │  ┌──────────────────────────────┐ │
        │  │ Autonomous Database (ATP)    │ │
        │  │ - 关键数据备份               │ │
        │  │ - 用户权限                   │ │
        │  │ - 系统配置                   │ │
        │  │ - 高可用性                   │ │
        │  └──────────────────────────────┘ │
        └────────────────────────────────────┘
```

---

## 📊 部署流程图

```
┌─────────────────────────────────────────────────────┐
│ 开始: 执行 bash deploy.sh                            │
└────────────────┬────────────────────────────────────┘
                 │
    ┌────────────▼────────────┐
    │ 步骤 1: 环境验证         │
    │ ✓ 检查工具安装          │
    │ ✓ 验证 OCI 连接         │
    │ ✓ 检查凭证              │
    └────────────┬────────────┘
                 │
    ┌────────────▼────────────────────┐
    │ 步骤 2: 构建 Docker 镜像          │
    │ ✓ 构建 Frontend 镜像            │
    │ ✓ 构建 Backend 镜像             │
    │ ✓ 构建 AI Service 镜像          │
    │ (约 10-15 分钟)                  │
    └────────────┬────────────────────┘
                 │
    ┌────────────▼──────────────────────┐
    │ 步骤 3: 登录和推送镜像              │
    │ ✓ 登录 OCI Container Registry    │
    │ ✓ 标签化镜像                     │
    │ ✓ 推送所有镜像                   │
    │ (约 5-10 分钟)                    │
    └────────────┬──────────────────────┘
                 │
    ┌────────────▼──────────────────────┐
    │ 步骤 4: 创建 OCI 基础设施           │
    │ (Terraform 初始化)                │
    │ ✓ 创建 VCN                       │
    │ ✓ 创建公共/私有子网               │
    │ ✓ 创建互联网网关                 │
    │ ✓ 创建路由表和安全组              │
    │ (约 5-10 分钟)                    │
    └────────────┬──────────────────────┘
                 │
    ┌────────────▼──────────────────────┐
    │ 步骤 5: 创建计算实例                │
    │ (Terraform apply)                 │
    │ ✓ 创建前端实例 (2vCPU/8GB)       │
    │ ✓ 创建后端实例 (2vCPU/8GB)       │
    │ ✓ 创建 AI 实例 (2vCPU/6GB)       │
    │ (约 10-15 分钟)                   │
    └────────────┬──────────────────────┘
                 │
    ┌────────────▼──────────────────────┐
    │ 步骤 6: 等待实例启动                │
    │ ✓ 安装 Docker                    │
    │ ✓ 配置系统                       │
    │ ✓ 启动 Docker 守护进程            │
    │ (约 5-10 分钟)                    │
    └────────────┬──────────────────────┘
                 │
    ┌────────────▼──────────────────────┐
    │ 步骤 7: 部署容器                    │
    │ ✓ SSH 连接到实例                 │
    │ ✓ 拉取 Docker 镜像               │
    │ ✓ 启动 docker-compose 容器       │
    │ (约 3-5 分钟)                     │
    └────────────┬──────────────────────┘
                 │
    ┌────────────▼──────────────────────┐
    │ 步骤 8: 初始化数据库                │
    │ ✓ 创建 PostgreSQL 数据库         │
    │ ✓ 运行 Prisma 迁移              │
    │ ✓ MongoDB 初始化                 │
    │ ✓ Neo4j 初始化                   │
    │ ✓ Qdrant 初始化                  │
    │ (约 2-3 分钟)                     │
    └────────────┬──────────────────────┘
                 │
    ┌────────────▼──────────────────────┐
    │ 步骤 9: 配置监控告警                │
    │ ✓ 创建成本告警                   │
    │ ✓ 创建存储告警                   │
    │ ✓ 启用 OCI 审计日志              │
    │ (约 1-2 分钟)                     │
    └────────────┬──────────────────────┘
                 │
    ┌────────────▼──────────────────────┐
    │ 步骤 10: 验证部署                   │
    │ ✓ 健康检查                       │
    │ ✓ API 检查                       │
    │ ✓ 数据库连接检查                 │
    │ (约 2-3 分钟)                     │
    └────────────┬──────────────────────┘
                 │
    ┌────────────▼──────────────────────┐
    │ ✅ 部署完成！                      │
    │                                  │
    │ 总耗时: 15-30 分钟                │
    │                                  │
    │ 输出:                            │
    │ 📱 前端: http://XXX.XXX.XXX.XXX  │
    │ 📊 后端: http://10.0.2.XXX:3001 │
    │ 🎯 AI: http://10.0.2.XXX:5000   │
    └──────────────────────────────────┘
```

---

## 🔄 容器编排架构

### Docker Compose 服务拓扑

```
Frontend Instance:
├── deepdive-frontend (Next.js)
│   └── Port 3000 (内部) → 80 (外部)
│       └── Nginx 反向代理

Backend Instance:
├── deepdive-backend (NestJS)
│   ├── Port 3001 (REST API)
│   └── GraphQL 查询
│
├── deepdive-postgres
│   ├── Port 5432
│   └── Data: /var/lib/postgresql/data
│
├── deepdive-redis
│   ├── Port 6379
│   └── Data: /data
│
├── deepdive-mongo
│   ├── Port 27017
│   └── Data: /data/db
│
└── deepdive-neo4j
    ├── Port 7474 (HTTP)
    ├── Port 7687 (Bolt)
    └── Data: /data, /logs

AI Instance:
├── deepdive-ai (FastAPI)
│   └── Port 5000
│
└── deepdive-qdrant
    ├── Port 6333 (REST)
    ├── Port 6334 (gRPC)
    └── Data: /qdrant/storage
```

---

## 🔐 网络隔离和安全

### 网络分段

```
互联网
  ↓
┌─────────────────────────────────────┐
│      OCI Load Balancer              │
│      Port 80, 443                   │
└──────────────┬──────────────────────┘
               │
        ┌──────▼──────────┐
        │   前端实例       │
        │ 公共子网        │
        │ 10.0.1.0/24    │
        │ 公网 IP        │
        └──────┬──────────┘
               │
        ┌──────▼──────────────────────┐
        │  内部通信 (VCN)              │
        │  仅 VCN 内部流量允许         │
        └──────┬──────────────────────┘
               │
        ┌──────▼──────────┐
        │  后端实例       │
        │ 私有子网        │
        │ 10.0.2.0/24    │
        │ 私有 IP        │
        │ 仅 VCN 可访问   │
        └─────────────────┘

        ┌──────────────────┐
        │  AI 实例         │
        │ 私有子网         │
        │ 10.0.2.0/24     │
        │ 私有 IP         │
        │ 仅 VCN 可访问    │
        └──────────────────┘
```

### 安全组规则

```
公共安全组 (前端):
┌─────────────────────────────────┐
│ 入站规则:                        │
│ ✓ TCP 80 (HTTP)       0.0.0.0/0 │
│ ✓ TCP 443 (HTTPS)     0.0.0.0/0 │
│ ✓ TCP 22 (SSH)        0.0.0.0/0 │
│                                  │
│ 出站规则:                        │
│ ✓ 所有协议 (All)      0.0.0.0/0 │
└─────────────────────────────────┘

私有安全组 (后端/AI):
┌─────────────────────────────────┐
│ 入站规则:                        │
│ ✓ 所有协议          10.0.1.0/24 │
│   (仅从公共子网)                 │
│                                  │
│ 出站规则:                        │
│ ✓ 所有协议          0.0.0.0/0    │
└─────────────────────────────────┘
```

---

## 💾 数据流和存储架构

### 数据流向

```
用户请求
  │
  ├─→ 前端 (Next.js)
  │    ├─→ 静态资源 (CDN/Nginx)
  │    └─→ 后端 API (REST/GraphQL)
  │
  ├─→ 后端 API (NestJS)
  │    ├─→ Redis 缓存
  │    │   └─→ 热数据缓存
  │    │
  │    ├─→ PostgreSQL
  │    │   └─→ 关键数据
  │    │
  │    ├─→ MongoDB
  │    │   └─→ 原始数据集合
  │    │
  │    └─→ Neo4j
  │        └─→ 知识图谱关系
  │
  └─→ AI 服务 (FastAPI)
       ├─→ Qdrant 向量数据库
       │   └─→ 向量嵌入索引
       │
       └─→ 机器学习模型
           └─→ 推荐/分类/聚类
```

### 存储架构

```
实例存储 (块存储):
├── 前端实例
│   └── 50GB (根卷)
│       └── OS + Docker + 镜像缓存
│
├── 后端实例
│   └── 50GB (根卷)
│       ├── OS
│       ├── Docker
│       ├── 数据库数据
│       └── 日志
│
└── AI 实例
    └── 50GB (根卷)
        ├── OS
        ├── Docker
        ├── 模型数据
        └── 日志

对象存储 (Object Storage):
├── deepdive-logs
│   ├── 应用日志 (2GB)
│   │   └── Lifecycle: 30 天删除
│   │
│   └── 系统日志 (1GB)
│       └── Lifecycle: 60 天删除
│
├── deepdive-backups
│   ├── PostgreSQL 备份 (3GB)
│   │   └── Lifecycle: 90 天删除
│   │
│   ├── MongoDB 备份 (2GB)
│   │   └── Lifecycle: 90 天删除
│   │
│   └── 配置备份 (100MB)
│       └── Lifecycle: 180 天删除
│
└── deepdive-data
    └── 用户上传文件 (5GB)
        └── Lifecycle: 删除后 30 天清空
```

---

## 🚀 CI/CD 流程架构

```
代码仓库 (GitHub)
    │
    ├─→ main 分支 push
    │
    └─→ GitHub Actions 触发
         │
         ├─ 构建阶段
         │  ├─→ Checkout 代码
         │  ├─→ 运行 ESLint
         │  ├─→ 运行 TypeScript 检查
         │  ├─→ 运行单元测试
         │  └─→ 构建应用
         │
         ├─ 镜像构建阶段
         │  ├─→ 构建 Frontend 镜像
         │  ├─→ 构建 Backend 镜像
         │  └─→ 构建 AI Service 镜像
         │
         ├─ 推送镜像阶段
         │  ├─→ 登录 OCI Registry
         │  ├─→ 推送 Frontend 镜像
         │  ├─→ 推送 Backend 镜像
         │  └─→ 推送 AI Service 镜像
         │
         └─ 部署阶段
            ├─→ 获取实例 IP
            ├─→ 通过 SSH 连接
            ├─→ 拉取新镜像
            ├─→ 重启容器
            ├─→ 验证部署
            └─→ Slack 通知
```

---

## 📈 监控和可观测性架构

```
应用监控
├── Docker 容器监控
│   ├─ CPU 使用率
│   ├─ 内存使用率
│   ├─ 磁盘 I/O
│   └─ 网络流量
│
├── 应用性能监控 (APM)
│   ├─ API 响应时间
│   ├─ 数据库查询时间
│   ├─ 缓存命中率
│   └─ 错误率
│
└── 业务监控
    ├─ 用户活跃度
    ├─ 转化率
    ├─ 数据质量
    └─ 系统可用性

日志和告警
├── 应用日志
│   ├─ 保存到 /var/log/
│   └─ 上传到 Object Storage
│
├── 系统日志
│   ├─ Docker 日志
│   ├─ 数据库日志
│   └─ 网络日志
│
├── OCI 监控
│   ├─ Compute 监控
│   ├─ 存储监控
│   └─ 网络监控
│
└── 告警规则
    ├─ CPU > 80% → 告警
    ├─ 内存 > 85% → 告警
    ├─ 存储 > 90% → 告警
    ├─ 错误率 > 1% → 告警
    └─ 成本 > 90% → 告警

通知渠道
├─ Slack (实时告警)
├─ Email (每日报告)
└─ SMS (关键告警)
```

---

## 🔄 备份和恢复架构

```
数据备份
├── PostgreSQL
│   ├─ 每日完整备份
│   ├─ 保留 90 天
│   └─ 存储于 Object Storage
│
├── MongoDB
│   ├─ 每周完整备份
│   ├─ 保留 60 天
│   └─ 增量备份每日
│
├── Neo4j
│   ├─ 每月完整备份
│   ├─ 保留 180 天
│   └─ 配置备份每日
│
└── 应用配置
    ├─ Docker Compose 配置
    ├─ 环境变量
    └─ SSL 证书

灾难恢复
├─ RTO (恢复时间): 1 小时
├─ RPO (数据损失): 1 天
│
└─ 恢复步骤:
   1. 创建新实例
   2. 安装应用
   3. 恢复数据库备份
   4. 恢复配置
   5. 验证服务
```

---

## 💰 成本优化架构

```
免费资源最大化
├── Compute
│   ├─ 使用 Ampere A1 (免费)
│   ├─ 4 vCPU + 24GB RAM
│   └─ 避免其他实例类型
│
├── 存储
│   ├─ 20GB Object Storage (免费)
│   ├─ 启用 Lifecycle 清理
│   └─ 避免多余备份
│
├── 数据库
│   ├─ ATP 免费 19GB
│   ├─ 容器数据库免费
│   └─ 优化查询减少存储
│
└── 网络
    ├─ 出站流量免费
    ├─ 10Mbps 限速
    └─ 使用压缩优化

成本监控
├── 实时使用监控
├── 每周成本报告
├── 告警阈值设置
└── 自动降级措施

降级策略
├─ 关闭 AI Service (省 2vCPU)
├─ 启用查询缓存 (省 CPU)
├─ 删除历史数据 (省存储)
└─ 优化镜像大小 (省流量)
```

---

## 🎯 关键架构决策

### 为什么选择这个架构？

| 决策           | 理由       | 优势               |
| -------------- | ---------- | ------------------ |
| 3 个实例       | 分离关注点 | 独立扩展，故障隔离 |
| 公共/私有子网  | 安全考虑   | 后端不暴露公网     |
| 容器化         | 标准化部署 | 一致性，易迁移     |
| docker-compose | 简单有效   | 免费，够用，易维护 |
| 混合数据库     | 最优成本   | ATP 免费，容器灵活 |
| 对象存储日志   | 低成本     | 自动清理，无限空间 |
| GitHub Actions | 自动化     | 免费，无服务器     |
| Terraform      | IaC        | 可重复，可版本控制 |

---

## 📊 性能指标目标

```
API 性能
├─ p50 响应时间: <100ms
├─ p95 响应时间: <200ms
├─ p99 响应时间: <500ms
└─ 吞吐量: >1000 req/s

页面加载性能
├─ 首字节时间: <500ms
├─ 首内容绘制: <1.5s
├─ 最大内容绘制: <2.5s
└─ 累积布局偏移: <0.1

资源使用效率
├─ CPU 使用率: <60%
├─ 内存使用率: <70%
├─ 磁盘使用率: <50%
└─ 网络带宽: <5Mbps

系统可靠性
├─ 可用性: 99.5%+
├─ 错误率: <0.1%
├─ 数据库连接时间: <50ms
└─ 缓存命中率: >80%
```

---

## 🔮 未来扩展方向

```
容器编排升级
├─ Docker → Kubernetes (OKE)
├─ 自动扩展
└─ 多节点部署

高可用架构
├─ 多实例负载均衡
├─ 自动故障转移
├─ 跨区域部署
└─ 主从数据库

性能优化
├─ 微服务架构
├─ GraphQL 优化
├─ 多级缓存
└─ CDN 集成

成本优化
├─ 预留实例
├─ 数据分片
├─ 混合云
└─ 自动伸缩

安全加固
├─ 零信任网络
├─ 加密传输
├─ 密钥管理
└─ 审计日志
```

---

## 总结

这个架构设计旨在：

- ✅ **最小化成本**: 完全使用免费资源
- ✅ **最大化可用性**: 分离关注点，故障隔离
- ✅ **简化运维**: 自动化部署，清晰的拓扑
- ✅ **易于扩展**: 模块化设计，易于升级
- ✅ **保证安全**: 网络隔离，安全组

---

**版本**: v1.0
**创建时间**: 2024
**维护者**: DeepDive 架构团队
